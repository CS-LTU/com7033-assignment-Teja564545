{% extends "base.html" %}
{% block title %}Patients{% endblock %}

{% block content %}
<div class="container main-container">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Patients</h2>

    <div class="d-flex gap-2">
      <a href="{{ url_for('patients_export') }}" class="btn btn-outline-primary btn-sm">
        ⬇ Export CSV
      </a>

      <a class="btn btn-primary btn-sm" href="{{ url_for('patient_create') }}">
        ➕ Add New Patient
      </a>
    </div>
  </div>

  <!-- SEARCH + FILTER FORM -->
  <form method="get" class="row g-2 mb-4 p-3 rounded border bg-light shadow-sm">

    <!-- Text search -->
    <div class="col-md-4">
      <input
        type="text"
        name="q"
        class="form-control"
        placeholder="Search by ID, work type, residence, smoking..."
        value="{{ q or '' }}"
      >
    </div>

    <!-- Gender filter -->
    <div class="col-md-3">
      <select name="gender" class="form-select">
        <option value="all">All genders</option>
        <option value="Male"   {% if selected_gender == 'Male' %}selected{% endif %}>Male</option>
        <option value="Female" {% if selected_gender == 'Female' %}selected{% endif %}>Female</option>
        <option value="Other"  {% if selected_gender == 'Other' %}selected{% endif %}>Other</option>
      </select>
    </div>

    <!-- Stroke filter -->
    <div class="col-md-3">
      <select name="stroke" class="form-select">
        <option value="all" {% if selected_stroke == 'all' %}selected{% endif %}>Stroke: All</option>
        <option value="yes" {% if selected_stroke == 'yes' %}selected{% endif %}>Stroke: Yes</option>
        <option value="no"  {% if selected_stroke == 'no' %}selected{% endif %}>Stroke: No</option>
      </select>
    </div>

    <!-- Buttons -->
    <div class="col-md-2 d-flex gap-2">
      <button type="submit" class="btn btn-outline-primary w-100">Search</button>
      <a href="{{ url_for('patients_list') }}" class="btn btn-outline-secondary w-100">Clear</a>
    </div>

  </form>

  <!-- PATIENTS TABLE -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <table class="table table-hover table-bordered mb-0 patient-table">
        <thead class="table-dark">
          <tr>
            {# helper macro for sortable column header #}
            {% macro sort_link(label, field) -%}
              {% set is_active = (sort == field) %}
              {% if is_active and direction == 'asc' %}
                {% set next_dir = 'desc' %}
                {% set arrow = '▲' %}
              {% elif is_active and direction == 'desc' %}
                {% set next_dir = 'asc' %}
                {% set arrow = '▼' %}
              {% else %}
                {% set next_dir = 'asc' %}
                {% set arrow = '' %}
              {% endif %}
              <a href="{{ url_for('patients_list',
                                   page=1,
                                   q=q,
                                   gender=selected_gender,
                                   stroke=selected_stroke,
                                   sort=field,
                                   direction=next_dir) }}"
                 class="text-decoration-none text-light">
                {{ label }} <span class="sort-arrow">{{ arrow }}</span>
              </a>
            {%- endmacro %}

            <th>{{ sort_link('ID', 'id') }}</th>
            <th>{{ sort_link('Age', 'age') }}</th>
            <th>{{ sort_link('Gender', 'gender') }}</th>
            <th>{{ sort_link('Stroke', 'stroke') }}</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for patient in patients.items %}
          {% set age_class = 'age-young' if patient.age < 40
                             else 'age-mid' if patient.age < 60
                             else 'age-old' %}
            <tr class="patient-row" onclick="window.location='{{ url_for('patient_detail', patient_id=patient.id) }}'">
            <td>{{ patient.id }}</td>
            <td>
              <span class="badge {{ age_class }}">
                {{ patient.age }}
              </span>
            </td>
            <td>{{ highlight(patient.gender, q) }}</td>

            <td>
              {% if patient.stroke %}
                <span class="badge bg-danger">Yes</span>
              {% else %}
                <span class="badge bg-success">No</span>
              {% endif %}
            </td>
            <td>
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ url_for('patient_detail', patient_id=patient.id) }}">
                View
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- PAGINATION -->
  <nav class="mt-3">
    <ul class="pagination justify-content-between">

      <!-- PREV BUTTON -->
      <li class="page-item {% if not patients.has_prev %}disabled{% endif %}">
        <a class="page-link animate-page"
           href="{{ url_for('patients_list',
                            page=patients.prev_num,
                            q=q,
                            gender=selected_gender,
                            stroke=selected_stroke,
                            sort=sort,
                            direction=direction) }}">
          « Previous
        </a>
      </li>

      <!-- PAGE INFO -->
      <li class="page-item disabled">
        <span class="page-link">
          Page {{ patients.page }} of {{ patients.pages or 1 }}
        </span>
      </li>

      <!-- NEXT BUTTON -->
      <li class="page-item {% if not patients.has_next %}disabled{% endif %}">
        <a class="page-link animate-page"

           href="{{ url_for('patients_list',
                            page=patients.next_num,
                            q=q,
                            gender=selected_gender,
                            stroke=selected_stroke,
                            sort=sort,
                            direction=direction) }}">
          Next »
        </a>
      </li>
    </ul>
  </nav>

</div>
{% endblock %}
